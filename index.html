<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Linktree</title>
    <link id="favicon-ico" rel="icon" type="image/png" href="">
    <link id="favicon-png" rel="icon" sizes="192x192" href="">
    <link id="apple-touch-icon" rel="apple-touch-icon" href="">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="dynamic-style-container"></div>
    
    <div class="container" id="page-container">
        </div>

    <template id="skeleton-template">
        <div class="container skeleton-container">
             <header>
                <div class="skeleton skeleton-avatar"></div>
                <div class="skeleton skeleton-text" style="width: 40%;"></div>
                <div class="skeleton skeleton-text" style="width: 60%;"></div>
            </header>
            <main>
                <ul class="links-list">
                    <li class="skeleton skeleton-button"></li>
                    <li class="skeleton skeleton-button"></li>
                    <li class="skeleton skeleton-button"></li>
                </ul>
            </main>
        </div>
    </template>
    
    <template id="content-template">
         <header>
            <img id="profile-picture" src="" alt="Photo de profil" class="profile-picture" data-editable-id="profile.pictureUrl">
            <h1 id="profile-title" data-editable-id="profile.title"></h1>
            <p id="profile-description" data-editable-id="profile.description"></p>
            <div id="social-icons" class="social-icons"></div>
        </header>
        <main>
            <div id="spotify-carousel-container"></div>
            <ul id="links-list" class="links-list"></ul>
        </main>
        <footer>
            <p>Powered by Vanilla JS</p>
        </footer>
    </template>


    <script>
        const ICONS = {
            github: `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.91 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>`,
            twitter: `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="currentColor"><path d="M24 4.557c-.883.392-1.832.656-2.828.775 1.017-.609 1.798-1.574 2.165-2.724-.951.564-2.005.974-3.127 1.195-.897-.957-2.178-1.555-3.594-1.555-3.179 0-5.515 2.966-4.797 6.045-4.091-.205-7.719-2.165-10.148-5.144-1.29 2.213-.669 5.108 1.523 6.574-.806-.026-1.566-.247-2.229-.616v.064c0 2.299 1.634 4.22 3.793 4.66-.426.115-.875.178-1.34.178-.288 0-.568-.027-.84-.079.588 1.834 2.273 3.226 4.312 3.262-1.68 1.332-3.83 2.115-6.177 2.115-.403 0-.8-.024-1.19-.069 2.175 1.433 4.823 2.253 7.693 2.253 9.218 0 14.26-7.824 13.999-14.646.962-.695 1.797-1.562 2.457-2.549z"/></svg>`,
            instagram: `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.85s-.012 3.584-.07 4.85c-.148 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.069-4.85.069s-3.584-.012-4.85-.07c-3.252-.148-4.771-1.691-4.919-4.919-.058-1.265-.069-1.645-.069-4.85s.012-3.584.07-4.85c.148-3.225 1.664-4.771 4.919-4.919 1.266-.058 1.644-.069 4.85-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948s.014 3.667.072 4.947c.2 4.358 2.618 6.78 6.98 6.98 1.281.059 1.689.073 4.948.073s3.667-.014 4.947-.072c4.358-.2 6.78-2.618 6.98-6.98.059-1.281.073-1.689.073-4.948s-.014-3.667-.072-4.947c-.2-4.358-2.618-6.78-6.98-6.98-1.281-.059-1.689-.073-4.948-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.162 6.162 6.162 6.162-2.759 6.162-6.162-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4s1.791-4 4-4 4 1.79 4 4-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44 1.441-.645 1.441-1.44-.645-1.44-1.441-1.44z"/></svg>`,
            linkedin: `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="currentColor"><path d="M4.98 3.5c0 1.381-1.11 2.5-2.48 2.5s-2.48-1.119-2.48-2.5c0-1.38 1.11-2.5 2.48-2.5s2.48 1.12 2.48 2.5zm.02 4.5h-5v16h5v-16zm7.982 0h-4.968v16h4.969v-8.399c0-4.67 6.029-5.052 6.029 0v8.399h4.988v-10.131c0-7.88-8.922-7.593-11.018-3.714v-2.155z"/></svg>`,
            youtube: `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="currentColor"><path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z"/></svg>`,
            facebook: `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="currentColor"><path d="M9 8h-3v4h3v12h5v-12h3.642l.358-4h-4v-1.667c0-.955.192-1.333 1.115-1.333h2.885v-5h-3.808c-3.596 0-5.192 1.583-5.192 4.615v3.385z"/></svg>`,
            tiktok: `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="currentColor"><path d="M19.333 6.427c-1.16-1.12-2.733-1.787-4.433-1.787-4.133 0-7.467 3.333-7.467 7.467s3.333 7.467 7.467 7.467c1.7 0 3.273-.667 4.433-1.787v-3.733h-2.133v3.467c-.667.4-1.467.667-2.3.667-2.533 0-4.6-2.067-4.6-4.6s2.067-4.6 4.6-4.6c.833 0 1.633.267 2.3.667v3.467h2.133v-3.733zM16.467 2c1.933 0 3.7.8 5 2.133v2.8h-2.133v-2.467c-.933-.8-2.133-1.333-3.467-1.333-3.133 0-5.667 2.533-5.667 5.667s2.533 5.667 5.667 5.667c1.333 0 2.533-.533 3.467-1.333v-2.467h2.133v2.8c-1.3 1.333-3.067 2.133-5 2.133-4.2 0-7.6-3.4-7.6-7.6s3.4-7.6 7.6-7.6z"/></svg>`,
            website: `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm0 22c-5.514 0-10-4.486-10-10s4.486-10 10-10 10 4.486 10 10-4.486 10-10 10zm-1-12h-3v2h3v3h2v-3h3v-2h-3v-3h-2v3z"/></svg>`,
        };

        const GRADIENTS = {
            "sunrise": "linear-gradient(135deg, #FFD3A5, #FD6585)",
            "ocean": "linear-gradient(135deg, #2E3192, #1BFFFF)",
            "dusk": "linear-gradient(135deg, #304352, #d7d2cc)"
        };
        
        const pageContainer = document.getElementById('page-container');

        function setFavicon(url) {
            if (!url) return;
            document.getElementById('favicon-ico').href = url;
            document.getElementById('favicon-png').href = url;
            document.getElementById('apple-touch-icon').href = url;
        }

        function renderPage(data) {
            pageContainer.innerHTML = '';
            const content = document.getElementById('content-template').content.cloneNode(true);
            pageContainer.appendChild(content);

            const { seo, appearance, profile, socials, links, songs } = data || {};
            if (!profile) return;

            document.title = seo?.title || profile?.title || 'Links';
            if (seo?.faviconUrl) setFavicon(seo.faviconUrl);

            const profileTitleEl = pageContainer.querySelector('#profile-title');
            const profileDescriptionEl = pageContainer.querySelector('#profile-description');

            if (appearance) {
                const header = pageContainer.querySelector('header');
                header.className = `layout-${appearance.pictureLayout || 'circle'}`;

                let fontLink = document.getElementById('dynamic-font-link');
                if (!fontLink) {
                    fontLink = document.createElement('link');
                    fontLink.id = 'dynamic-font-link';
                    fontLink.rel = 'stylesheet';
                    document.head.appendChild(fontLink);
                }
                
                if (appearance.fontFamily) {
                    const fontName = appearance.fontFamily.split(',')[0].replace(/'/g, '').trim();
                    fontLink.href = `https://fonts.googleapis.com/css2?family=${fontName.replace(/ /g, "+")}:wght@400;600;700&display=swap`;
                }

                let backgroundValue;
                const bg = appearance.background;
                if (bg.type === 'image') {
                    backgroundValue = `url(${bg.value})`;
                } else if (bg.type === 'gradient') {
                    backgroundValue = GRADIENTS[bg.value] || bg.value; 
                } else {
                    backgroundValue = bg.value;
                }
                
                const styles = `:root {
                    --font-family: ${appearance.fontFamily || 'Inter, sans-serif'};
                    --background: ${backgroundValue};
                    --text-color: ${appearance.textColor};
                    
                    --link-bg: ${appearance.link.backgroundColor};
                    --link-text: ${appearance.link.textColor};
                    --link-radius: ${appearance.link.borderRadius};
                    --link-border: ${appearance.link.borderWidth} solid ${appearance.link.borderColor};
                    
                    --header-bg: ${appearance.header.backgroundColor};
                    --header-text: ${appearance.header.textColor};
                    --header-radius: ${appearance.header.borderRadius};
                    --header-border: ${appearance.header.borderWidth} solid ${appearance.header.borderColor};
                }`;
                document.getElementById('dynamic-style-container').innerHTML = `<style>${styles}</style>`;

                profileTitleEl.style.color = appearance.titleColor || 'inherit';
                profileDescriptionEl.style.color = appearance.descriptionColor || 'inherit';
            }

            pageContainer.querySelector('#profile-picture').src = profile?.pictureUrl || '';
            profileTitleEl.innerHTML = profile?.title || '';
            profileDescriptionEl.innerHTML = profile?.description || '';
            
            const socialContainer = pageContainer.querySelector('#social-icons');
            socialContainer.innerHTML = '';
            (socials || []).forEach(social => {
                if (!social.url || !ICONS[social.network]) return;
                const a = document.createElement('a');
                a.href = social.url;
                a.target = '_blank';
                a.rel = "noopener noreferrer";
                a.title = social.network;
                a.innerHTML = ICONS[social.network];
                a.dataset.editableId = `socials.${social.id}`;
                a.draggable = true;
                socialContainer.appendChild(a);
            });
            
            // Rendu du carrousel Spotify
            const spotifyContainer = pageContainer.querySelector('#spotify-carousel-container');
            if (songs && songs.length > 0) {
                spotifyContainer.innerHTML = `
                    <h2 class="section-title">Mes sons du moment</h2>
                    <div class="spotify-carousel">
                        ${songs.map(song => `
                            <a href="${song.spotifyUrl}" target="_blank" class="song-card" data-editable-id="songs.${song.songId}">
                                <img src="${song.albumArtUrl}" alt="Pochette de ${song.title}">
                                <div class="song-title">${song.title}</div>
                                <div class="song-artist">${song.artist}</div>
                            </a>
                        `).join('')}
                    </div>
                `;
            }


            const linksList = pageContainer.querySelector('#links-list');
            linksList.innerHTML = '';
            (links || []).forEach(item => {
                const li = document.createElement('li');
                li.dataset.editableId = `links.${item.id}`;
                li.draggable = true;

                if (item.type === 'header') {
                    li.classList.add('list-header');
                    li.innerHTML = `<span>${item.title}</span>`;
                } else {
                    const a = document.createElement('a');
                    let url = item.url;
                    if (url && !/^(https?:\/\/|mailto:)/i.test(url)) {
                        url = '//' + url;
                    }
                    a.href = url;
                    a.target = "_blank";
                    a.rel = "noopener noreferrer";
                    
                    if (item.thumbnailUrl) {
                        a.classList.add('has-thumbnail');
                        a.innerHTML = `<img src="${item.thumbnailUrl}" alt="" class="link-thumbnail"><span>${item.title}</span>`;
                    } else { a.innerHTML = item.title; }
                    li.appendChild(a);
                }
                linksList.appendChild(li);
            });
        }

        function postMessageToParent(type, payload) {
            window.parent.postMessage({ type, payload }, '*');
        }

        function attachAllListeners() {
            document.body.addEventListener('contextmenu', e => {
                const target = e.target.closest('[data-editable-id]');
                if (!target) return;
                e.preventDefault();
                postMessageToParent('showContextMenu', { 
                    id: target.dataset.editableId, 
                    x: e.clientX, 
                    y: e.clientY 
                });
            });

            let draggedItem = null;
            
            function getDragAfterElement(container, y) {
                const draggableElements = [...container.querySelectorAll('[draggable="true"]:not(.dragging)')];
                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    if (offset < 0 && offset > closest.offset) {
                        return { offset, element: child };
                    }
                    return closest;
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }

            document.body.addEventListener('dragstart', e => {
                const target = e.target.closest('[data-editable-id]');
                if (!target) return e.preventDefault();
                draggedItem = target;
                setTimeout(() => target.style.opacity = '0.5', 0);
            });

            document.body.addEventListener('dragend', e => {
                if (draggedItem) {
                    draggedItem.style.opacity = '1';
                    draggedItem = null;
                }
            });

            document.body.addEventListener('dragover', e => {
                e.preventDefault();
            });

            document.body.addEventListener('drop', e => {
                e.preventDefault();
                if (!draggedItem) return;
                
                const targetContainer = e.target.closest('.links-list, .social-icons, .spotify-carousel');
                const draggedContainer = draggedItem.closest('.links-list, .social-icons, .spotify-carousel');
                
                if (!targetContainer || targetContainer !== draggedContainer) {
                    draggedItem.style.opacity = '1';
                    draggedItem = null;
                    return;
                }

                const afterElement = getDragAfterElement(targetContainer, e.clientY);
                const draggedId = draggedItem.dataset.editableId;
                const targetId = afterElement ? afterElement.dataset.editableId : null;
                
                postMessageToParent('reorder', { draggedId, targetId });
            });
        }
        
        const isIframe = window.self !== window.top;

        if (isIframe) {
            window.addEventListener('message', event => {
                if (event.data.type === 'update') {
                    renderPage(event.data.payload);
                }
            });
            attachAllListeners();
        } else {
            document.addEventListener('DOMContentLoaded', () => {
                const skeleton = document.getElementById('skeleton-template').content.cloneNode(true);
                pageContainer.appendChild(skeleton);

                fetch('https://reliable-hamster-b1e205.netlify.app/.netlify/functions/get-data')
                    .then(res => res.json())
                    .then(data => {
                        renderPage(data)
                    })
                    .catch(err => {
                        pageContainer.innerHTML = `<p class="default-message">Impossible de charger les liens.</p>`;
                        console.error(err);
                    });
            });
        }
    </script>
</body>
</html>